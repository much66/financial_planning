<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Financial Model</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel (untuk memproses JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load SheetJS (XLSX) untuk Export/Import Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Style tambahan jika perlu -->
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <!-- Container Utama Aplikasi -->
    <div id="root"></div>

    <!-- Kode Aplikasi React -->
    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        // --- ICON COMPONENTS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const Calendar = (props) => <IconWrapper {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
        const Edit3 = (props) => <IconWrapper {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconWrapper>;
        const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>;
        const Upload = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>;
        const Lightbulb = (props) => <IconWrapper {...props}><line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 16.5 8 4.5 4.5 0 0 0 12 3.5 4.5 4.5 0 0 0 7.5 8c0 1.57.81 2.92 2 3.73V14h5.59z"/></IconWrapper>;

        // --- HELPER FUNCTIONS ---
        
        const formatCurrency = (num) => {
            if (num === '' || num === null || num === undefined) return '';
            let str = num.toString().replace(/\./g, '');
            if (str.startsWith('-')) {
                return '-' + str.substring(1).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            return str.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };
        const parseCurrency = (str) => {
            if (!str) return "";
            return str.toString().replace(/\./g, '');
        };

        const formatDecimal = (num) => {
             if (num === '' || num === null || num === undefined) return '';
             if (typeof num === 'number') {
                 if (num % 1 !== 0) {
                     return num.toFixed(1).replace('.', ',');
                 }
             }
             return num.toString().replace('.', ',');
        }
        const parseDecimal = (str) => {
             if(!str) return '';
             return str.toString().replace(',', '.');
        }

        // --- SUB COMPONENTS ---

        const Section = ({ title, children }) => (
            <div className="mb-6 border-b pb-4 last:border-0">
                <h3 className="text-xs font-bold uppercase text-gray-400 mb-3">{title}</h3>
                <div className="space-y-3">{children}</div>
            </div>
        );

        const Input = ({ label, name, val, onChange, suffix }) => {
            const isPercentage = suffix === '%'; 
            const [localVal, setLocalVal] = useState("");
            const [isEditing, setIsEditing] = useState(false);

            useEffect(() => {
                if (!isEditing) {
                    const formatted = isPercentage ? formatDecimal(val) : formatCurrency(val);
                    setLocalVal(formatted);
                }
            }, [val, isEditing, isPercentage]);

            const handleLocalChange = (e) => {
                const v = e.target.value;
                const regex = isPercentage ? /^[\d,]*$/ : /^[-]?[\d.]*$/;
                if (regex.test(v)) {
                    setLocalVal(v); 
                    const parsed = isPercentage ? parseDecimal(v) : parseCurrency(v);
                    onChange({
                        target: { name: name, value: parsed }
                    });
                }
            };

            return (
                <div className="flex justify-between items-center mb-2 last:mb-0">
                    <label className="text-xs text-gray-600 truncate mr-2 flex-1" title={label}>{label}</label>
                    <div className="flex items-center">
                        <input 
                            type="text"
                            inputMode={isPercentage ? "decimal" : "numeric"}
                            value={localVal} 
                            onChange={handleLocalChange}
                            onFocus={() => setIsEditing(true)}
                            onBlur={() => setIsEditing(false)}
                            className={`p-1 text-right text-xs border rounded bg-gray-50 focus:bg-white focus:ring-1 focus:ring-emerald-500 outline-none ${isPercentage ? 'w-16' : 'w-24'}`}
                            autoComplete="off"
                        />
                        {suffix && <span className="text-[10px] text-gray-400 ml-1 w-3">{suffix}</span>}
                    </div>
                </div>
            );
        };

        const OpexInput = ({ label, id, inputs, onChange }) => {
            const fixedName = `opex_${id}_fixed`;
            const pctName = `opex_${id}_pct`;
            
            const [localFix, setLocalFix] = useState("");
            const [editFix, setEditFix] = useState(false);
            
            useEffect(() => {
                if(!editFix) setLocalFix(formatCurrency(inputs[fixedName]));
            }, [inputs[fixedName], editFix]);

            const changeFix = (e) => {
                const v = e.target.value;
                if (/^[\d.]*$/.test(v)) {
                    setLocalFix(v);
                    onChange({ target: { name: fixedName, value: parseCurrency(v) } });
                }
            };

            const [localPct, setLocalPct] = useState("");
            const [editPct, setEditPct] = useState(false);

            useEffect(() => {
                if(!editPct) setLocalPct(formatDecimal(inputs[pctName]));
            }, [inputs[pctName], editPct]);

            const changePct = (e) => {
                const v = e.target.value;
                if (/^[\d,]*$/.test(v)) {
                    setLocalPct(v);
                    onChange({ target: { name: pctName, value: parseDecimal(v) } });
                }
            };

            return (
                <div className="flex items-center justify-between mb-2">
                    <label className="text-xs text-gray-600 truncate flex-1 mr-1" title={label}>{label}</label>
                    <div className="flex gap-1">
                        <div className="relative">
                            <input 
                                type="text" 
                                value={localFix} 
                                onChange={changeFix}
                                onFocus={() => setEditFix(true)}
                                onBlur={() => setEditFix(false)}
                                className="w-24 p-1 pr-6 text-right text-xs border rounded bg-gray-50 focus:bg-white focus:ring-1 focus:ring-emerald-500 outline-none"
                                placeholder="Fix"
                                autoComplete="off"
                            />
                            <span className="absolute right-1.5 top-1 text-[10px] text-gray-400 pointer-events-none">Rp</span>
                        </div>
                        <div className="relative">
                            <input 
                                type="text"
                                inputMode="decimal"
                                value={localPct} 
                                onChange={changePct}
                                onFocus={() => setEditPct(true)}
                                onBlur={() => setEditPct(false)}
                                className="w-12 p-1 pr-5 text-right text-xs border rounded bg-gray-50 focus:bg-white focus:ring-1 focus:ring-emerald-500 outline-none"
                                placeholder="%"
                            />
                            <span className="absolute right-1 top-1 text-[10px] text-gray-400 pointer-events-none">%</span>
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({ title, value, sub, color }) => (
            <div className={`p-4 rounded shadow-sm border ${color}`}>
                <h3 className="text-xs font-bold opacity-70 uppercase">{title}</h3>
                <div className="text-2xl font-bold my-1 flex items-baseline gap-1">
                    {value}
                </div>
                <p className="text-xs opacity-80">{sub}</p>
            </div>
        );

        const TableContainer = ({ children }) => (
            <div className="bg-white rounded shadow-sm border border-gray-200 overflow-x-auto">
                <table className="w-full text-sm min-w-[1000px]">
                {children}
                </table>
            </div>
        );

        const TableHead = ({ data }) => (
            <thead className="bg-gray-100 text-gray-600">
                <tr>
                <th className="text-left p-3 min-w-[150px] sticky left-0 bg-gray-100 border-r border-gray-200 z-10">Item (Juta IDR)</th>
                {data.map(m => (
                    <th key={m.month} className="text-center p-3 font-medium min-w-[80px]">{m.name}</th>
                ))}
                </tr>
            </thead>
        );

        const Row = ({ label, data = [], field, bold, bg, bgDouble, neg, negRed, highlight, borderT, italic, textGray, editable, overrides, onCellChange, indent, subHeader }) => {
            const getVal = (obj, path) => path.split('.').reduce((o, i) => o[i], obj);
            const fmt = (n) => new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(n);

            if (subHeader) {
                return (
                    <tr className="bg-gray-50/50">
                        <td className="p-2 sticky left-0 border-r border-gray-200 z-10 text-xs font-bold text-gray-500 uppercase tracking-wider pl-4 bg-gray-50">{label}</td>
                        <td colSpan={data.length || 12}></td>
                    </tr>
                )
            }

            return (
                <tr className={`
                group
                ${bg ? 'bg-gray-50' : ''} 
                ${bgDouble ? 'bg-emerald-50' : ''} 
                ${borderT ? 'border-t-2 border-gray-300' : 'border-b border-gray-50'}
                ${highlight ? 'bg-yellow-50' : ''}
                hover:bg-gray-100 transition-colors duration-150
                `}>
                <td className={`
                    p-2 sticky left-0 border-r border-gray-200 z-10 flex items-center gap-1
                    transition-colors duration-150
                    ${bold ? 'font-bold' : ''}
                    ${highlight ? 'bg-yellow-50 text-blue-800' : bgDouble ? 'bg-emerald-50' : bg ? 'bg-gray-50' : 'bg-white'}
                    group-hover:bg-gray-100
                    ${italic ? 'italic' : ''}
                    ${textGray ? 'text-gray-500' : ''}
                    ${indent ? 'pl-6' : ''}
                `}>
                    {label}
                    {editable && <Edit3 size={10} className="text-gray-400" />}
                </td>
                
                {data.map((m, i) => {
                    const val = getVal(m, field);
                    const displayVal = neg ? -val : val;
                    // FIX -0: check if absolute value is very small
                    const isNeg = displayVal < -0.01;
                    const isZero = Math.abs(displayVal) < 0.01;

                    if (editable) {
                        const isOverridden = overrides && overrides[m.month] !== undefined;
                        const cellValue = isOverridden ? overrides[m.month] : (val || 0);
                        
                        return (
                            <td key={i} className="p-1 text-right">
                            <input 
                                type="text"
                                placeholder="-"
                                value={formatCurrency(cellValue === 0 ? '' : cellValue)} 
                                onChange={(e) => {
                                    const v = e.target.value;
                                    if (/^[-]?[\d.]*$/.test(v)) {
                                        onCellChange(m.month, parseCurrency(v));
                                    }
                                }}
                                className={`
                                w-full text-right p-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-emerald-500
                                ${isOverridden ? 'bg-blue-50 border-blue-300 font-bold text-blue-700' : 'bg-transparent border-transparent hover:border-gray-300'}
                                `}
                            />
                            </td>
                        );
                    }

                    return (
                    <td key={i} className={`
                        p-2 text-right 
                        ${bold ? 'font-bold' : ''}
                        ${(negRed || isNeg) && isNeg ? 'text-red-500' : ''}
                        ${textGray ? 'text-gray-500' : ''}
                    `}>
                        {isZero ? '-' : (displayVal < 0 ? `(${fmt(Math.abs(displayVal))})` : fmt(displayVal))}
                    </td>
                    );
                })}
                </tr>
            );
        };

        // --- MAIN APP COMPONENT ---

        const MonthlyFinancialModel = () => {
            const [activeTab, setActiveTab] = useState('income'); 
            const fileInputRef = useRef(null);

            // --- 1. INITIAL ASSUMPTIONS ---
            const [inputs, setInputs] = useState({
                baseRevenue: 0, monthlyGrowth: 0, 
                returnPct: 0.1, consignmentPct: 12.15, platformPct: 3.33,     
                cogsPct: 40, 
                opex_mkt_fixed: 0, opex_mkt_pct: 5,
                opex_content_fixed: 0, opex_content_pct: 2,
                opex_salary_fixed: 0, opex_salary_pct: 7,
                opex_rent_fixed: 0, opex_rent_pct: 2.5,
                opex_office_fixed: 0, opex_office_pct: 3,
                opex_repair_fixed: 0, opex_repair_pct: 0.35,
                opex_rnd_fixed: 0, opex_rnd_pct: 0.1,
                depreciationRate: 0.7, taxRate: 22, annualInterestRate: 6, 
                dsi: 150, dpo: 60, 
                // --- UPDATE: Default Start Cash = 0, Inventory = 30.500 ---
                startCash: 0, 
                startInventory: 30500, 
                startFixedAssets: 5000,
                // --- UPDATE: DEFAULT START DEBT & EQUITY = 0 ---
                startDebt: 0, 
                startEquity: 0, 
                startRetainedEarnings: 0 
            });

            // State for Overrides (Manual Inputs)
            // UPDATED: Month 3 changed from 37922 to 37923
            const [revenueOverrides, setRevenueOverrides] = useState({
                1: 18942, 2: 34700, 3: 37923, 4: 18083, 5: 21607, 6: 20657,
                7: 17809, 8: 17564, 9: 17504, 10: 17589, 11: 23020, 12: 19602
            });
            const [capexOverrides, setCapexOverrides] = useState({});
            
            // Split Debt & Equity into In/Out
            const [debtInOverrides, setDebtInOverrides] = useState({});
            const [debtOutOverrides, setDebtOutOverrides] = useState({});
            const [equityInOverrides, setEquityInOverrides] = useState({});
            const [equityOutOverrides, setEquityOutOverrides] = useState({});

            const handleChange = (e) => {
                const { name, value } = e.target;
                const numValue = value === "" ? 0 : parseFloat(value);
                setInputs(prev => ({ ...prev, [name]: isNaN(numValue) ? 0 : numValue }));
            };

            const handleOverrideChange = (setter, month, val) => {
                setter(prev => {
                    const newOverrides = { ...prev };
                    if (val === '' || val === null || val === '-') { 
                        delete newOverrides[month]; 
                    } else {
                        newOverrides[month] = parseFloat(val);
                    }
                    return newOverrides;
                });
            };

            const handleRevenueChange = (m, v) => handleOverrideChange(setRevenueOverrides, m, v);
            const handleCapexChange = (m, v) => handleOverrideChange(setCapexOverrides, m, v);
            const handleDebtInChange = (m, v) => handleOverrideChange(setDebtInOverrides, m, v);
            const handleDebtOutChange = (m, v) => handleOverrideChange(setDebtOutOverrides, m, v);
            const handleEquityInChange = (m, v) => handleOverrideChange(setEquityInOverrides, m, v);
            const handleEquityOutChange = (m, v) => handleOverrideChange(setEquityOutOverrides, m, v);

            // --- EXPORT TO EXCEL ---
            const handleExport = () => {
                const wb = XLSX.utils.book_new();

                const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const headerRow = ["Item", ...monthNames];
                const toReal = (n) => (n || 0) * 1_000_000;

                // 1. Tab Income Statement
                const incomeRows = [
                    headerRow,
                    ["Gross Revenue", ...monthlyData.map(m => toReal(m.pl.rev))],
                    ["(-) Sales Return", ...monthlyData.map(m => toReal(-m.pl.salesReturn))],
                    ["(-) Consignment Fee", ...monthlyData.map(m => toReal(-m.pl.consignmentFee))],
                    ["(-) Platform Fee", ...monthlyData.map(m => toReal(-m.pl.platformFee))],
                    ["Net Revenue", ...monthlyData.map(m => toReal(m.pl.netRevenue))],
                    ["(-) COGS", ...monthlyData.map(m => toReal(-m.pl.cogs))],
                    ["Gross Profit", ...monthlyData.map(m => toReal(m.pl.gp))],
                    
                    ["Operating Expenses (Detail)", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["(-) Pemasaran & Iklan", ...monthlyData.map(m => toReal(-m.pl.opex_mkt))],
                    ["(-) Konten Kreatif", ...monthlyData.map(m => toReal(-m.pl.opex_content))],
                    ["(-) Gaji & THR", ...monthlyData.map(m => toReal(-m.pl.opex_salary))],
                    ["(-) Sewa", ...monthlyData.map(m => toReal(-m.pl.opex_rent))],
                    ["(-) Beban Kantor", ...monthlyData.map(m => toReal(-m.pl.opex_office))],
                    ["(-) Perbaikan", ...monthlyData.map(m => toReal(-m.pl.opex_repair))],
                    ["(-) R&D", ...monthlyData.map(m => toReal(-m.pl.opex_rnd))],

                    ["Total Operating Expenses", ...monthlyData.map(m => toReal(-m.pl.totalOpex))],
                    
                    ["EBITDA", ...monthlyData.map(m => toReal(m.pl.ebitda))], 
                    ["(-) Amortization & Depr", ...monthlyData.map(m => toReal(-m.pl.depr))],
                    ["EBIT", ...monthlyData.map(m => toReal(m.pl.ebit))],
                    ["(-) Finance Cost", ...monthlyData.map(m => toReal(-m.pl.int))],
                    ["(-) Tax", ...monthlyData.map(m => toReal(-m.pl.tax))],
                    ["Net Income", ...monthlyData.map(m => toReal(m.pl.netIncome))],
                ];
                const wsIncome = XLSX.utils.aoa_to_sheet(incomeRows);
                XLSX.utils.book_append_sheet(wb, wsIncome, "Income Statement");

                // 2. Tab Cash Flow
                const cfRows = [
                    headerRow,
                    ["Net Income", ...monthlyData.map(m => toReal(m.cf.ni))],
                    ["(+) Amort & Depr", ...monthlyData.map(m => toReal(m.cf.depr))],
                    ["(Inc)/Dec Inventory", ...monthlyData.map(m => toReal(m.cf.chgInv))],
                    ["Inc/(Dec) Trade Payable", ...monthlyData.map(m => toReal(m.cf.chgAp))],
                    ["Cash From Ops", ...monthlyData.map(m => toReal(m.cf.cfo))],
                    
                    // --- REARRANGED INVESTING ACTIVITIES ---
                    ["Investing Activities", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["Capex (Belanja Aset)", ...monthlyData.map(m => toReal(m.cf.capex))],
                    ["Cash In from Investment", ...monthlyData.map(m => toReal(m.cf.eqIn))],
                    ["Cash Out from Investment", ...monthlyData.map(m => toReal(-m.cf.eqOut))],
                    ["Cash From Investing", ...monthlyData.map(m => toReal(m.cf.cfi))],

                    // --- REARRANGED FINANCING ACTIVITIES ---
                    ["Financing Activities", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["Financing", ...monthlyData.map(m => toReal(m.cf.debtIn))],
                    ["Financing Repayment", ...monthlyData.map(m => toReal(-m.cf.debtOut))],
                    ["Cash From Financing", ...monthlyData.map(m => toReal(m.cf.cff))],
                    
                    ["Net Cash Change", ...monthlyData.map(m => toReal(m.cf.netChange))],
                    ["Beg. Cash", ...monthlyData.map(m => toReal(m.cf.begCash))],
                    ["End. Cash", ...monthlyData.map(m => toReal(m.cf.endCash))],
                ];
                const wsCf = XLSX.utils.aoa_to_sheet(cfRows);
                XLSX.utils.book_append_sheet(wb, wsCf, "Cash Flow");

                // 3. Tab Balance Sheet (UPDATED LABELS)
                const bsRows = [
                    headerRow,
                    ["ASSETS", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["Cash", ...monthlyData.map(m => toReal(m.bs.cash))],
                    ["Inventory", ...monthlyData.map(m => toReal(m.bs.inventory))],
                    ["Fixed Assets", ...monthlyData.map(m => toReal(m.bs.fixedAssets))],
                    ["TOTAL ASSETS", ...monthlyData.map(m => toReal(m.bs.totalAssets))],
                    
                    ["LIABILITIES", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["Trade Payable", ...monthlyData.map(m => toReal(m.bs.ap))],
                    ["Loan from Investors", ...monthlyData.map(m => toReal(m.bs.debt))],
                    ["TOTAL LIABILITIES", ...monthlyData.map(m => toReal(m.bs.totalLiabilities))],
                    
                    ["EQUITY", "", "", "", "", "", "", "", "", "", "", "", ""],
                    ["Injection Capital", ...monthlyData.map(m => toReal(m.bs.equity))],
                    ["Retained Earnings", ...monthlyData.map(m => toReal(m.bs.re))],
                    ["TOTAL EQUITY", ...monthlyData.map(m => toReal(m.bs.totalEquity))],

                    ["TOTAL LIAB & EQ", ...monthlyData.map(m => toReal(m.bs.totalLiabEq))],
                ];
                const wsBs = XLSX.utils.aoa_to_sheet(bsRows);
                XLSX.utils.book_append_sheet(wb, wsBs, "Balance Sheet");

                // 4. Tab Variables
                const variableRows = [
                    ["VARIABLE_KEY", "VALUE"],
                    ...Object.entries(inputs),
                    ["REVENUE_OVERRIDES_JSON", JSON.stringify(revenueOverrides)],
                    ["CAPEX_OVERRIDES_JSON", JSON.stringify(capexOverrides)],
                    ["DEBT_IN_OVERRIDES", JSON.stringify(debtInOverrides)],
                    ["DEBT_OUT_OVERRIDES", JSON.stringify(debtOutOverrides)],
                    ["EQUITY_IN_OVERRIDES", JSON.stringify(equityInOverrides)],
                    ["EQUITY_OUT_OVERRIDES", JSON.stringify(equityOutOverrides)]
                ];
                const wsVars = XLSX.utils.aoa_to_sheet(variableRows);
                XLSX.utils.book_append_sheet(wb, wsVars, "Variables");

                XLSX.writeFile(wb, "Financial_Model_Export.xlsx");
            };

            // --- IMPORT FROM EXCEL ---
            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });

                    const wsName = "Variables";
                    if (!wb.Sheets[wsName]) {
                        alert("File Excel tidak valid atau tidak memiliki tab 'Variables'.");
                        return;
                    }

                    const ws = wb.Sheets[wsName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    const newInputs = { ...inputs };
                    let newRev = {}, newCapex = {};
                    let newDebtIn = {}, newDebtOut = {};
                    let newEqIn = {}, newEqOut = {};

                    let oldDebtOverrides = null, oldEquityOverrides = null;

                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row && row.length >= 2) {
                            const key = row[0];
                            const val = row[1];

                            try {
                                if (key === "REVENUE_OVERRIDES_JSON") newRev = JSON.parse(val);
                                else if (key === "CAPEX_OVERRIDES_JSON") newCapex = JSON.parse(val);
                                else if (key === "DEBT_IN_OVERRIDES") newDebtIn = JSON.parse(val);
                                else if (key === "DEBT_OUT_OVERRIDES") newDebtOut = JSON.parse(val);
                                else if (key === "EQUITY_IN_OVERRIDES") newEqIn = JSON.parse(val);
                                else if (key === "EQUITY_OUT_OVERRIDES") newEqOut = JSON.parse(val);
                                else if (key === "DEBT_OVERRIDES_JSON") oldDebtOverrides = JSON.parse(val);
                                else if (key === "EQUITY_OVERRIDES_JSON") oldEquityOverrides = JSON.parse(val);
                                else if (newInputs.hasOwnProperty(key)) {
                                    newInputs[key] = parseFloat(val);
                                }
                            } catch (err) {
                                console.error("Error parsing", key, err);
                            }
                        }
                    }

                    if (oldDebtOverrides) {
                        Object.entries(oldDebtOverrides).forEach(([m, v]) => {
                            if (v > 0) newDebtIn[m] = v;
                            if (v < 0) newDebtOut[m] = Math.abs(v);
                        });
                    }
                    if (oldEquityOverrides) {
                        Object.entries(oldEquityOverrides).forEach(([m, v]) => {
                            if (v > 0) newEqIn[m] = v;
                            if (v < 0) newEqOut[m] = Math.abs(v);
                        });
                    }

                    setInputs(newInputs);
                    setRevenueOverrides(newRev);
                    setCapexOverrides(newCapex);
                    setDebtInOverrides(newDebtIn);
                    setDebtOutOverrides(newDebtOut);
                    setEquityInOverrides(newEqIn);
                    setEquityOutOverrides(newEqOut);
                    
                    alert("Data berhasil diimport!");
                };
                reader.readAsBinaryString(file);
                e.target.value = null;
            };


            // --- 2. CALCULATION ENGINE ---
            const monthlyData = useMemo(() => {
                let data = [];
                const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                
                let prev = {
                    rev: 0,
                    inventory: inputs.startInventory,
                    ap: (inputs.baseRevenue * (inputs.cogsPct/100) / 30) * inputs.dpo, 
                    fixedAssets: inputs.startFixedAssets,
                    cash: inputs.startCash,
                    re: inputs.startRetainedEarnings,
                    debt: inputs.startDebt,
                    equity: inputs.startEquity
                };

                for (let m = 1; m <= 12; m++) {
                    let grossRev;
                    if (revenueOverrides[m] !== undefined) {
                        grossRev = revenueOverrides[m];
                    } else {
                        grossRev = m === 1 ? inputs.baseRevenue : prev.rev * (1 + inputs.monthlyGrowth / 100);
                    }

                    const salesReturn = grossRev * (inputs.returnPct / 100);
                    const consignmentFee = grossRev * (inputs.consignmentPct / 100);
                    const platformFee = grossRev * (inputs.platformPct / 100);
                    const netRevenue = grossRev - salesReturn - consignmentFee - platformFee;

                    const cogs = grossRev * (inputs.cogsPct / 100);
                    const grossProfit = netRevenue - cogs;
                    
                    const calcOpex = (id) => inputs[`opex_${id}_fixed`] + (netRevenue * (inputs[`opex_${id}_pct`] / 100));
                    const opex_mkt = calcOpex('mkt');
                    const opex_content = calcOpex('content');
                    const opex_salary = calcOpex('salary');
                    const opex_rent = calcOpex('rent');
                    const opex_office = calcOpex('office');
                    const opex_repair = calcOpex('repair');
                    const opex_rnd = calcOpex('rnd');
                    const totalOpex = opex_mkt + opex_content + opex_salary + opex_rent + opex_office + opex_repair + opex_rnd;

                    const depr = (inputs.startFixedAssets * (inputs.depreciationRate / 100)) / 12; 
                    
                    const ebitda = grossProfit - totalOpex;
                    const ebit = ebitda - depr;
                    const debtIn = debtInOverrides[m] || 0;
                    const eqIn = equityInOverrides[m] || 0; // CASH IN FROM INVESTMENT - Treat as LOAN inflow
                    const interestBase = prev.debt + debtIn + eqIn; 
                    const interest = (interestBase * (inputs.annualInterestRate/100)) / 12; 
                    
                    const ebt = ebit - interest;
                    const tax = ebt > 0 ? ebt * (inputs.taxRate / 100) : 0;
                    const netIncome = ebt - tax;

                    // --- CASH FLOW INPUTS RETRIEVAL ---
                    const capex = capexOverrides[m] || 0;
                    // Debt (Financing)
                    // debtIn already defined
                    const debtOut = debtOutOverrides[m] || 0;
                    const chgDebt = debtIn - debtOut + eqIn; // eqIn adds to debt now
                    // Equity (Investing in this context based on user request, logic remains same for balance impact)
                    // eqIn defined above
                    const eqOut = equityOutOverrides[m] || 0;
                    const chgEquity = - eqOut; // eqIn moved to debt

                    // D. BALANCE SHEET
                    const inventory = (cogs / 30) * inputs.dsi;
                    const ap = (cogs / 30) * inputs.dpo;
                    const fixedAssets = prev.fixedAssets - depr + capex; 
                    const re = prev.re + netIncome;
                    const debt = prev.debt + chgDebt;
                    const equity = prev.equity + chgEquity;

                    const totalLiabilities = ap + debt;
                    const totalEquity = equity + re;

                    // E. CASH FLOW
                    const cfo_ni = netIncome;
                    const cfo_depr = depr;
                    const cfo_inv = -(inventory - prev.inventory);
                    const cfo_ap = (ap - prev.ap);
                    const cfo_total = cfo_ni + cfo_depr + cfo_inv + cfo_ap;

                    // Investing Activities: Capex + Equity Changes (As per request)
                    // Note: Ideally Equity is Financing, but user requested to group under Investing visually or logically?
                    // Re-reading request: "capital itu saya ingin ada di bagian investing"
                    // So we move Equity In/Out lines to Investing section in display.
                    // But calculate totals:
                    // CFI = -Capex + Equity In - Equity Out (If moving Capital to Investing)
                    const cfi_total = -capex + eqIn - eqOut; 

                    // Financing Activities: Debt only
                    const cff_total = debtIn - debtOut;
                    
                    const netChange = cfo_total + cfi_total + cff_total;
                    const endCash = prev.cash + netChange;

                    const monthObj = {
                        month: m,
                        name: monthNames[m-1],
                        pl: { 
                            rev: grossRev, 
                            salesReturn, consignmentFee, platformFee, netRevenue,
                            cogs, gp: grossProfit, 
                            opex_mkt, opex_content, opex_salary, opex_rent, opex_office, opex_repair, opex_rnd,
                            totalOpex,
                            ebitda, depr, ebit, int: interest, tax, netIncome 
                        },
                        bs: { 
                            cash: endCash, inventory, fixedAssets, totalAssets: endCash + inventory + fixedAssets, 
                            ap, debt, totalLiabilities, 
                            equity, re, totalEquity,    
                            totalLiabEq: totalLiabilities + totalEquity 
                        },
                        cf: { 
                            ni: cfo_ni, depr: cfo_depr, chgInv: cfo_inv, chgAp: cfo_ap, cfo: cfo_total, 
                            capex, 
                            debtIn, debtOut, chgDebt, 
                            eqIn, eqOut, chgEquity, 
                            cfi: cfi_total, // Modified to include equity
                            cff: cff_total, // Modified to exclude equity
                            netChange, begCash: prev.cash, endCash 
                        }
                    };

                    data.push(monthObj);
                    prev = { ...monthObj.bs, rev: grossRev, inventory: inventory, ap: ap, cash: endCash };
                }

                return data;
            }, [inputs, revenueOverrides, capexOverrides, debtInOverrides, debtOutOverrides, equityInOverrides, equityOutOverrides]); 

            const fmt = (n) => new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(n);

            const totalGrossRev = monthlyData.reduce((acc, curr) => acc + curr.pl.rev, 0);
            const totalNetIncome = monthlyData.reduce((acc, curr) => acc + curr.pl.netIncome, 0);
            const netIncomeMargin = totalGrossRev ? (totalNetIncome / totalGrossRev) * 100 : 0;

            // --- CAPITAL SUGGESTION LOGIC ---
            // Find month with minimum Cash balance
            const lowestCashMonth = monthlyData.reduce((min, curr) => curr.bs.cash < min.bs.cash ? curr : min, monthlyData[0]);
            // If minimum cash < 0, calculate how much is needed to bring it to 0
            const requiredCapital = lowestCashMonth.bs.cash < 0 ? Math.abs(lowestCashMonth.bs.cash) : 0;

            const applyCapitalSuggestion = () => {
                setEquityInOverrides(prev => {
                    const currentVal = prev[1] || 0;
                    return {
                        ...prev,
                        1: currentVal + requiredCapital
                    };
                });
                alert(`Berhasil menambahkan Injection Capital sebesar ${fmt(requiredCapital)} Juta di Bulan 1.`);
            };

            return (
                <div className="flex flex-col h-screen bg-gray-50 text-slate-800 font-sans">
                {/* Header */}
                <div className="bg-emerald-900 text-white p-4 shadow-md flex justify-between items-center">
                    <div>
                    <h1 className="text-xl font-bold flex items-center gap-2">
                        <Calendar size={24} /> Monthly Financial Model
                    </h1>
                    <p className="text-emerald-200 text-xs">Retail Projections with Detailed Opex</p>
                    </div>
                    <div className="flex gap-2">
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            onChange={handleFileChange} 
                            accept=".xlsx, .xls" 
                            style={{display: 'none'}} 
                        />
                        <button onClick={handleImportClick} className="flex items-center gap-1 text-xs bg-emerald-700 px-3 py-1 rounded hover:bg-emerald-600 text-white border border-emerald-600">
                            <Upload size={14}/> Import
                        </button>
                        <button onClick={handleExport} className="flex items-center gap-1 text-xs bg-white text-emerald-900 px-3 py-1 rounded hover:bg-gray-100 font-bold">
                            <Download size={14}/> Export Excel
                        </button>
                        <button onClick={() => {
                            if(confirm("Reset semua edit manual?")) {
                                setRevenueOverrides({});
                                setCapexOverrides({});
                                setDebtInOverrides({}); setDebtOutOverrides({});
                                setEquityInOverrides({}); setEquityOutOverrides({});
                            }
                        }} className="text-xs bg-emerald-800 px-3 py-1 rounded hover:bg-emerald-700 text-white">Reset Edits</button>
                        <button onClick={() => window.location.reload()} className="p-2 hover:bg-emerald-800 rounded"><RefreshCw size={18}/></button>
                    </div>
                </div>

                <div className="flex flex-col md:flex-row h-full overflow-hidden">
                    
                    {/* SIDEBAR INPUTS */}
                    <div className="w-full md:w-80 bg-white border-r border-gray-200 overflow-y-auto p-4 flex-shrink-0 shadow-inner z-20">
                    <h2 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><TrendingUp size={18}/> Assumptions</h2>
                    
                    <div className="space-y-6 text-sm">
                        <Section title="1. Revenue Deductions">
                            <div className="text-[10px] text-gray-500 mb-2 italic">
                                *Gross Revenue diatur manual melalui tabel (Edit Mode).
                            </div>
                            <Input label="Retur Penjualan" name="returnPct" val={inputs.returnPct} onChange={handleChange} suffix="%"/>
                            <Input label="Consignment Fee" name="consignmentPct" val={inputs.consignmentPct} onChange={handleChange} suffix="%"/>
                            <Input label="Platform Fee" name="platformPct" val={inputs.platformPct} onChange={handleChange} suffix="%"/>
                            <div className="my-2 border-t border-dashed"></div>
                            <Input label="COGS (% Gross)" name="cogsPct" val={inputs.cogsPct} onChange={handleChange} suffix="%"/>
                        </Section>

                        <Section title="2. Operating Expenses (Opex)">
                            <div className="bg-blue-50 p-2 rounded mb-2 text-[10px] text-blue-800 leading-tight">
                                Isi kolom <b>Fix (Juta)</b> atau <b>% (dari Net Sales)</b> atau keduanya.
                            </div>
                            <OpexInput label="Pemasaran & Iklan" id="mkt" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Konten Kreatif" id="content" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Gaji & THR" id="salary" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Sewa Tempat" id="rent" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Beban Kantor (Listrik/ATK)" id="office" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Perbaikan & Maintenance" id="repair" inputs={inputs} onChange={handleChange} />
                            <OpexInput label="Riset & Pengembangan" id="rnd" inputs={inputs} onChange={handleChange} />
                        </Section>

                        <Section title="3. Financials & Taxes">
                            <Input label="Depreciation Rate" name="depreciationRate" val={inputs.depreciationRate} onChange={handleChange} suffix="%"/>
                            <Input label="Finance Cost (p.a)" name="annualInterestRate" val={inputs.annualInterestRate} onChange={handleChange} suffix="%"/>
                            <Input label="Tax Rate" name="taxRate" val={inputs.taxRate} onChange={handleChange} suffix="%"/>
                        </Section>

                        <Section title="4. Working Capital & Balance">
                            <Input label="Days Inventory" name="dsi" val={inputs.dsi} onChange={handleChange} suffix="Hr"/>
                            <Input label="Days Payable" name="dpo" val={inputs.dpo} onChange={handleChange} suffix="Hr"/>
                            <div className="my-2 border-t border-dashed"></div>
                            <Input label="Start Cash" name="startCash" val={inputs.startCash} onChange={handleChange} suffix="Jt"/>
                            <Input label="Start Inventory" name="startInventory" val={inputs.startInventory} onChange={handleChange} suffix="Jt"/>
                            {/* Inputs updated to use new labels */}
                            <Input label="Start Loan (Inv.)" name="startDebt" val={inputs.startDebt} onChange={handleChange} suffix="Jt"/>
                            <Input label="Start Injection Cap." name="startEquity" val={inputs.startEquity} onChange={handleChange} suffix="Jt"/>
                        </Section>
                    </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 flex flex-col min-w-0 bg-gray-50">
                    <div className="flex bg-white border-b border-gray-200 px-4 pt-2 gap-4 overflow-x-auto">
                        {['dashboard', 'income', 'cashflow', 'balance'].map(t => (
                        <button 
                            key={t}
                            onClick={() => setActiveTab(t)}
                            className={`pb-2 px-2 text-sm font-medium capitalize ${activeTab === t ? 'text-emerald-700 border-b-2 border-emerald-600' : 'text-gray-500 hover:text-gray-700'}`}
                        >
                            {t === 'dashboard' ? 'Summary Dashboard' : t + ' Statement'}
                        </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-auto p-4">
                        
                        {/* DASHBOARD & OTHER TABS (Same as before) */}
                        {activeTab === 'dashboard' && (
                        <div className="space-y-6">
                            {/* --- HERO CARD FOR GROSS REVENUE --- */}
                            <div className="bg-white rounded shadow-sm border border-indigo-100 p-6 flex items-center justify-between bg-gradient-to-r from-indigo-50 to-white">
                                <div>
                                    <h3 className="text-sm font-bold opacity-70 uppercase text-indigo-900">Total Gross Revenue (Omzet Kotor)</h3>
                                    <div className="text-4xl font-bold my-2 text-indigo-800">{fmt(totalGrossRev)}</div>
                                    <p className="text-sm text-indigo-600 opacity-80">Total Pendapatan Sebelum Potongan</p>
                                </div>
                                <div className="hidden md:block text-indigo-200">
                                    <TrendingUp size={48} />
                                </div>
                            </div>

                            {/* --- CAPITAL SUGGESTION CARD --- */}
                            {requiredCapital > 0 && (
                                <div className="bg-yellow-50 rounded shadow-sm border border-yellow-200 p-4 flex flex-col md:flex-row items-center justify-between gap-4 animate-pulse-slow">
                                    <div className="flex items-start gap-3">
                                        <div className="bg-yellow-100 p-2 rounded-full text-yellow-600 mt-1">
                                            <Lightbulb size={24} />
                                        </div>
                                        <div>
                                            <h3 className="text-sm font-bold text-yellow-800">Saran Modal Awal (Capital Injection)</h3>
                                            <p className="text-xs text-yellow-700 mt-1 max-w-lg">
                                                Berdasarkan proyeksi, saldo kas Anda akan negatif sebesar <b>{fmt(requiredCapital)} Juta</b> di bulan <b>{lowestCashMonth.name}</b>.
                                                Disarankan untuk menambah modal awal agar cashflow aman.
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={applyCapitalSuggestion}
                                        className="whitespace-nowrap px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold rounded shadow transition-colors"
                                    >
                                        Apply (+{fmt(requiredCapital)} Jt) to Month 1
                                    </button>
                                </div>
                            )}

                            {/* --- KEY METRICS GRID --- */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <Card title="Total Net Revenue" value={fmt(monthlyData.reduce((acc, curr) => acc + curr.pl.netRevenue, 0))} sub="Juta IDR (After Fees)" color="bg-blue-50 text-blue-800" />
                                <Card title="Total Opex (Year)" value={fmt(monthlyData.reduce((acc, curr) => acc + curr.pl.totalOpex, 0))} sub="Total Beban Operasional" color="bg-orange-50 text-orange-800" />
                                <Card 
                                    title="Net Income (NPAT)" 
                                    value={
                                        <>
                                            {fmt(totalNetIncome)}
                                            <span className="text-sm font-normal ml-2 opacity-80">({formatDecimal(netIncomeMargin)}%)</span>
                                        </>
                                    } 
                                    sub="% dari Gross Revenue" 
                                    color="bg-purple-50 text-purple-800" 
                                />
                            </div>
                            
                            {/* NEW ROW FOR LIABILITIES & EQUITY */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <Card title="Total Liabilities (End Year)" value={fmt(monthlyData[11].bs.totalLiabilities)} sub="Posisi Akhir Tahun (Bulan 12)" color="bg-red-50 text-red-800" />
                                <Card title="Total Equity (End Year)" value={fmt(monthlyData[11].bs.totalEquity)} sub="Posisi Akhir Tahun (Bulan 12)" color="bg-emerald-50 text-emerald-800" />
                            </div>

                            {/* ... Dashboard Charts ... */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div className="bg-white p-4 rounded shadow-sm border">
                                    <h3 className="font-bold text-gray-700 mb-4">Opex Breakdown (Total Setahun)</h3>
                                    <div className="space-y-2 text-xs">
                                        {[
                                            {l: 'Pemasaran & Iklan', v: monthlyData.reduce((a,c)=>a+c.pl.opex_mkt,0)},
                                            {l: 'Gaji & THR', v: monthlyData.reduce((a,c)=>a+c.pl.opex_salary,0)},
                                            {l: 'Sewa', v: monthlyData.reduce((a,c)=>a+c.pl.opex_rent,0)},
                                            {l: 'Lain-lain (Konten, Kantor, dll)', v: monthlyData.reduce((a,c)=>a+c.pl.opex_content+c.pl.opex_office+c.pl.opex_repair+c.pl.opex_rnd,0)}
                                        ].sort((a,b)=>b.v-a.v).map((x,i) => (
                                            <div key={i} className="flex justify-between items-center border-b border-dashed pb-1">
                                                <span>{x.l}</span>
                                                <span className="font-bold">{fmt(x.v)}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow-sm border">
                                    <h3 className="font-bold text-gray-700 mb-4">Cash Trend</h3>
                                    <div className="flex space-x-2 h-32 items-end">
                                        {monthlyData.map((m, i) => (
                                        <div key={i} className="flex-1 bg-emerald-100 rounded-t relative group" style={{height: '100%'}}>
                                            <div 
                                                className={`absolute bottom-0 w-full rounded-t ${m.bs.cash < 0 ? 'bg-red-400' : 'bg-emerald-500'}`} 
                                                style={{ height: `${Math.max(5, Math.min(100, (Math.abs(m.bs.cash) / Math.max(...monthlyData.map(x=>Math.abs(x.bs.cash))) * 100)))}%` }}
                                            ></div>
                                            <div className="absolute bottom-full mb-1 hidden group-hover:block bg-black text-white text-[10px] p-1 rounded z-10">{fmt(m.bs.cash)}</div>
                                        </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}

                        {activeTab === 'income' && (
                        <TableContainer>
                            <TableHead data={monthlyData} />
                            <tbody>
                            <Row label="Gross Revenue" data={monthlyData} field="pl.rev" bold editable overrides={revenueOverrides} onCellChange={handleRevenueChange}/>
                            <Row label="(-) Sales Return" data={monthlyData} field="pl.salesReturn" neg textGray indent />
                            <Row label="(-) Consignment Fee" data={monthlyData} field="pl.consignmentFee" neg textGray indent />
                            <Row label="(-) Platform Fee" data={monthlyData} field="pl.platformFee" neg textGray indent />
                            <Row label="Net Revenue" data={monthlyData} field="pl.netRevenue" bold bg borderT />
                            <Row label="(-) COGS" data={monthlyData} field="pl.cogs" neg />
                            <Row label="Gross Profit" data={monthlyData} field="pl.gp" bold bg Double />
                            
                            <Row label="Operating Expenses" subHeader data={monthlyData} />
                            <Row label="(-) Pemasaran & Iklan" data={monthlyData} field="pl.opex_mkt" neg indent />
                            <Row label="(-) Konten Kreatif" data={monthlyData} field="pl.opex_content" neg indent />
                            <Row label="(-) Gaji & THR" data={monthlyData} field="pl.opex_salary" neg indent />
                            <Row label="(-) Sewa" data={monthlyData} field="pl.opex_rent" neg indent />
                            <Row label="(-) Beban Kantor" data={monthlyData} field="pl.opex_office" neg indent />
                            <Row label="(-) Perbaikan" data={monthlyData} field="pl.opex_repair" neg indent />
                            <Row label="(-) R&D" data={monthlyData} field="pl.opex_rnd" neg indent />
                            <Row label="Total Opex" data={monthlyData} field="pl.totalOpex" bold bg neg />

                            <Row label="EBITDA" data={monthlyData} field="pl.ebitda" bold />
                            <Row label="(-) Amortization & Depr" data={monthlyData} field="pl.depr" neg textGray />
                            <Row label="EBIT" data={monthlyData} field="pl.ebit" bold />
                            <Row label="(-) Finance Cost" data={monthlyData} field="pl.int" neg />
                            <Row label="(-) Tax" data={monthlyData} field="pl.tax" neg />
                            <Row label="Net Income" data={monthlyData} field="pl.netIncome" bold bgDouble />
                            </tbody>
                        </TableContainer>
                        )}

                        {activeTab === 'balance' && (
                        <TableContainer>
                            <TableHead data={monthlyData} />
                            <tbody>
                                <tr className="bg-emerald-50"><td className="p-2 font-bold text-xs uppercase text-emerald-800 sticky left-0 bg-emerald-50">ASSETS</td><td colSpan={12}></td></tr>
                                <Row label="Cash" data={monthlyData} field="bs.cash" highlight />
                                <Row label="Inventory" data={monthlyData} field="bs.inventory" />
                                <Row label="Fixed Assets" data={monthlyData} field="bs.fixedAssets" />
                                <Row label="TOTAL ASSETS" data={monthlyData} field="bs.totalAssets" bold borderT />
                                
                                {/* NEW BREAKDOWN: LIABILITIES */}
                                <tr className="bg-emerald-50"><td className="p-2 font-bold text-xs uppercase text-emerald-800 sticky left-0 bg-emerald-50 mt-4">LIABILITIES</td><td colSpan={12}></td></tr>
                                {/* Updated Label */}
                                <Row label="Trade Payable" data={monthlyData} field="bs.ap" />
                                {/* Updated Label */}
                                <Row label="Loan from Investors" data={monthlyData} field="bs.debt" />
                                <Row label="TOTAL LIABILITIES" data={monthlyData} field="bs.totalLiabilities" bold bg />

                                {/* NEW BREAKDOWN: EQUITY */}
                                <tr className="bg-emerald-50"><td className="p-2 font-bold text-xs uppercase text-emerald-800 sticky left-0 bg-emerald-50 mt-4">EQUITY</td><td colSpan={12}></td></tr>
                                {/* Updated Label */}
                                <Row label="Injection Capital" data={monthlyData} field="bs.equity" />
                                <Row label="Retained Earnings" data={monthlyData} field="bs.re" />
                                <Row label="TOTAL EQUITY" data={monthlyData} field="bs.totalEquity" bold bg />
                                
                                <Row label="TOTAL LIAB & EQ" data={monthlyData} field="bs.totalLiabEq" bold borderT />
                                
                                {/* CHECK ROW WITH SMART TOOLTIP */}
                                <tr>
                                <td className="p-2 text-xs font-bold sticky left-0 bg-white border-r">Check Balance</td>
                                {monthlyData.map((m, i) => {
                                    const diff = m.bs.totalAssets - m.bs.totalLiabEq;
                                    const isBalanced = Math.abs(diff) < 0.1; 
                                    return (
                                    <td key={i} className="p-2 text-center border-b align-top relative group">
                                        {isBalanced ? <CheckCircle size={14} className="text-green-500 mx-auto"/> : 
                                        <div className="flex flex-col items-center cursor-help">
                                            <AlertCircle size={14} className="text-red-500"/>
                                            <span className="text-[9px] text-red-500 font-bold">{fmt(diff)}</span>
                                            
                                            {/* TOOLTIP */}
                                            <div className="absolute bottom-full mb-2 hidden group-hover:block bg-slate-800 text-white text-[10px] p-3 rounded z-20 w-56 text-left shadow-lg border border-slate-600">
                                                <p className="font-bold mb-1 text-red-300">Neraca Tidak Seimbang!</p>
                                                <p className="mb-2">Selisih: {fmt(diff)} Juta</p>
                                                <div className="border-t border-slate-600 my-1"></div>
                                                <p className="font-bold text-slate-300 mb-1">Saran Perbaikan:</p>
                                                <ul className="list-disc pl-3 space-y-1 text-slate-200">
                                                    {diff > 0 ? (
                                                        <>
                                                            <li>Aset lebih besar dari Pasiva.</li>
                                                            <li><b>Solusi:</b> Tambah <span className="text-emerald-300">Start Injection Cap.</span> atau <span className="text-emerald-300">Start Loan</span> di Sidebar sebesar <b>{fmt(Math.abs(diff))}</b>.</li>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <li>Pasiva lebih besar dari Aset.</li>
                                                            <li><b>Solusi:</b> Kurangi <span className="text-orange-300">Start Injection Cap.</span> atau <span className="text-orange-300">Start Loan</span> di Sidebar sebesar <b>{fmt(Math.abs(diff))}</b>.</li>
                                                        </>
                                                    )}
                                                </ul>
                                            </div>
                                        </div>
                                        }
                                    </td>
                                    );
                                })}
                                </tr>
                            </tbody>
                        </TableContainer>
                        )}

                        {activeTab === 'cashflow' && (
                        <TableContainer>
                            <TableHead data={monthlyData} />
                            <tbody>
                            <Row label="Net Income" data={monthlyData} field="cf.ni" bold />
                            <Row label="(+) Amortization & Depreciation" data={monthlyData} field="cf.depr" />
                            <Row label="(Inc)/Dec Inventory" data={monthlyData} field="cf.chgInv" negRed />
                            {/* Updated Label */}
                            <Row label="Inc/(Dec) Trade Payable" data={monthlyData} field="cf.chgAp" />
                            <Row label="Cash From Ops" data={monthlyData} field="cf.cfo" bold bg />
                            
                            {/* --- MOVED INVESTING: CAPEX & CAPITAL --- */}
                            <Row label="Investing Activities" subHeader data={monthlyData} />
                            <Row label="(-) Capex / Belanja Aset" data={monthlyData} field="cf.capex" negRed editable overrides={capexOverrides} onCellChange={handleCapexChange} />
                            
                            <Row label="(+) Cash In from Investment (Suntik Modal)" data={monthlyData} field="cf.eqIn" 
                                editable overrides={equityInOverrides} onCellChange={handleEquityInChange} />
                                
                            <Row label="(-) Cash Out from Investment (Tarik Modal)" data={monthlyData} field="cf.eqOut" negRed
                                editable overrides={equityOutOverrides} onCellChange={handleEquityOutChange} />

                            <Row label="Cash From Investing" data={monthlyData} field="cf.cfi" bold bg />

                            {/* --- MOVED FINANCING: DEBT ONLY --- */}
                            <Row label="Financing Activities" subHeader data={monthlyData} />
                            
                            <Row label="(+) Financing (Pinjaman Masuk)" data={monthlyData} field="cf.debtIn" 
                                editable overrides={debtInOverrides} onCellChange={handleDebtInChange} />
                            
                            <Row label="(-) Financing Repayment (Bayar Pinjaman)" data={monthlyData} field="cf.debtOut" negRed
                                editable overrides={debtOutOverrides} onCellChange={handleDebtOutChange} />

                            <Row label="Cash From Financing" data={monthlyData} field="cf.cff" bold bg />

                            <Row label="Net Cash Change" data={monthlyData} field="cf.netChange" bold borderT />
                            <Row label="Beg. Cash" data={monthlyData} field="cf.begCash" italic textGray />
                            <Row label="End. Cash" data={monthlyData} field="cf.endCash" bold bgDouble />
                            </tbody>
                        </TableContainer>
                        )}

                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonthlyFinancialModel />);
    </script>
</body>
</html>
